---
// src/pages/denuncia.astro
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import VozComunidade from '../components/VozComunidade.astro'; // Importe o componente do card

// Busca TODAS as den√∫ncias e ordena da mais recente para a mais antiga
const todasDenuncias = (await getCollection('denuncias')).sort(
  (a, b) => new Date(b.data.data).getTime() - new Date(a.data.data).getTime()
);

// Lista de bairros consolidada baseada no Ramal Guapimirim
const bairros = [ "√Årea Rural de Guapimirim", "Bananal", "Barreira", "Cadetes Fabres", "Caneca Fina", "Cantagalo", "Centro", "Citrol√¢ndia", "Corujas", "Cotia", "Espinha√ßo", "Garraf√£o", "Iconha", "Jardim Guapimirim", "Limoeiro", "Monte Oliveti", "Nova Mar√≠lia", "Orindi", "Paiol", "Ideal", "Parque Santo Ant√¥nio (Modelo)", "Para√≠so", "Parque Fleixal", "Parque Nossa Senhora da Ajuda", "Parque Santa Eug√™nia", "Parque Silvestre", "Quinta Mariana", "Quinta Ros√¢ngela", "Segredo", "Soberbo", "Vale das Pedrinhas", "Vale do Jequitib√°", "V√°rzea Alegre", "Vila Ol√≠mpia" ];

const problemas = [ "Falta de √Ågua", "Coleta de Lixo", "Ilumina√ß√£o P√∫blica", "Problemas no Trem (Diesel)", "Seguran√ßa", "Buracos/Pavimenta√ß√£o" ];
---

<Layout title="Voz da Comunidade - Den√∫ncias | emguapi.com">
    <Navbar />

    <main class="max-w-4xl mx-auto p-6 my-12">
        
        <section class="bg-white shadow-2xl rounded-[2.5rem] overflow-hidden border-t-8 border-red-base p-8 md:p-12 mb-20">
            <header class="mb-10 text-center">
                <h1 class="text-4xl font-black text-navy-dark uppercase italic tracking-tighter">
                    Voz da <span class="text-red-base">Comunidade</span>
                </h1>
                <p class="text-navy-soft mt-2 font-medium italic">O canal de utilidade p√∫blica de Guapimirim</p>
            </header>

            <form id="denuncia-form" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Localidade</label>
                        <select id="bairro-form" required class="w-full bg-ice text-navy-dark p-4 rounded-xl font-bold border-2 border-transparent focus:border-red-base outline-none transition-all">
                            <option value="">Selecione o Bairro</option>
                            {bairros.map(b => <option value={b}>{b}</option>)}
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Assunto</label>
                        <select id="assunto-form" required class="w-full bg-ice text-navy-dark p-4 rounded-xl font-bold border-2 border-transparent focus:border-red-base outline-none transition-all">
                            <option value="">Tipo de Ocorr√™ncia</option>
                            {problemas.map(p => <option value={p}>{p}</option>)}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Relato do Morador</label>
                    <textarea id="relato-form" rows="5" required placeholder="Descreva o problema com detalhes..." class="w-full bg-ice text-navy-dark p-4 rounded-xl font-medium border-2 border-transparent focus:border-red-base outline-none resize-none transition-all"></textarea>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Seu Nome (Opcional)</label>
                    <input type="text" id="nome-form" placeholder="Ex: Dona Maria ou Morador do Centro" class="w-full bg-ice text-navy-dark p-4 rounded-xl font-bold border-2 border-transparent focus:border-red-base outline-none transition-all" />
                </div>
                <button type="submit" class="w-full bg-navy-dark hover:bg-red-base text-white p-5 rounded-2xl font-black uppercase tracking-widest shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3">
                    Enviar para a Reda√ß√£o no WhatsApp
                </button>
            </form>
            <div class="mt-8 p-4 bg-ice rounded-xl border-l-4 border-navy-soft text-center">
                <p class="text-[10px] text-navy-soft uppercase font-bold">As den√∫ncias s√£o recebidas pela nossa equipe e podem ser transformadas em pautas jornal√≠sticas.</p>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-black uppercase tracking-tighter text-navy-dark mb-10 flex items-center gap-3 italic">
                <span class="w-10 h-1.5 bg-red-base inline-block"></span>
                Relatos Recentes
            </h2>

            <div id="denuncias-list" class="grid md:grid-cols-2 gap-6 mb-12">
                {todasDenuncias.length > 0 ? (
                    todasDenuncias.map((relato, index) => (
                        // O atributo data-hidden controla se o item est√° vis√≠vel ou n√£o.
                        // Os primeiros 4 (√≠ndices 0, 1, 2, 3) s√£o vis√≠veis. O resto √© oculto.
                        <div class="denuncia-item transition-all duration-500" data-hidden={index >= 4 ? "true" : "false"}>
                            <VozComunidade 
                                bairro={relato.data.bairro}
                                relato={relato.data.resumo_relato}
                                autor={relato.data.autor}
                            />
                        </div>
                    ))
                ) : (
                    <div class="col-span-2 bg-white p-12 rounded-[2.5rem] text-center border border-ice shadow-xl">
                        <p class="text-navy-soft italic text-lg mb-4">Ainda n√£o h√° relatos publicados.</p>
                    </div>
                )}
            </div>

            {todasDenuncias.length > 4 && (
                <div class="text-center">
                    <button 
                        id="btn-carregar-mais"
                        class="group flex items-center gap-2 mx-auto text-xs font-black uppercase tracking-widest text-navy-base hover:text-white hover:bg-navy-base transition-all px-8 py-4 rounded-full border-2 border-navy-base"
                    >
                        Carregar mais 4 relatos
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:translate-y-1 transition-transform">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <p id="msg-fim-lista" class="hidden text-xs font-black uppercase tracking-[0.2em] text-navy-soft opacity-50 mt-4">
                        Todos os relatos foram exibidos.
                    </p>
                </div>
            )}
        </section>

    </main>
</Layout>

<style>
    /* Esconde os itens que t√™m o atributo data-hidden="true" */
    .denuncia-item[data-hidden="true"] {
        display: none;
        opacity: 0;
        transform: translateY(20px);
    }
    /* Mostra os itens com data-hidden="false" com uma anima√ß√£o suave */
    .denuncia-item[data-hidden="false"] {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script>
    // --- Script do Formul√°rio de Envio ---
    const form = document.getElementById('denuncia-form') as HTMLFormElement;
    if (form) {
        form.addEventListener('submit', (e: Event) => {
            e.preventDefault();
            const bairro = (document.getElementById('bairro-form') as HTMLSelectElement).value;
            const assunto = (document.getElementById('assunto-form') as HTMLSelectElement).value;
            const relato = (document.getElementById('relato-form') as HTMLTextAreaElement).value;
            const nome = (document.getElementById('nome-form') as HTMLInputElement).value || "Morador An√¥nimo";
            const meuTelefone = "5521969400053"; 
            const mensagem = `üì¢ *DEN√öNCIA - emguapi.com*%0A%0A*Local:* ${bairro}%0A*Assunto:* ${assunto}%0A*Relato:* ${relato}%0A%0A*Enviado por:* ${nome}`;
            window.open(`https://api.whatsapp.com/send?phone=${meuTelefone}&text=${mensagem}`, '_blank');
        });
    }

    // --- Script da Pagina√ß√£o "Carregar Mais" ---
    const btnCarregarMais = document.getElementById('btn-carregar-mais');
    const msgFimLista = document.getElementById('msg-fim-lista');
    let itensVisiveis = 4; // Come√ßamos mostrando 4
    const itensPorPagina = 4; // Carregamos mais 4 a cada clique

    if (btnCarregarMais) {
        btnCarregarMais.addEventListener('click', () => {
            // Seleciona todos os itens que est√£o escondidos no momento
            const itensEscondidos = document.querySelectorAll('.denuncia-item[data-hidden="true"]');
            
            // Pega os pr√≥ximos 'itensPorPagina' (ex: 4) dessa lista de escondidos
            const proximosItens = Array.from(itensEscondidos).slice(0, itensPorPagina);

            // Se n√£o houver mais itens para mostrar...
            if (proximosItens.length === 0) {
                btnCarregarMais.classList.add('hidden'); // Esconde o bot√£o
                msgFimLista?.classList.remove('hidden'); // Mostra a mensagem de fim
                return;
            }

            // Para cada um dos pr√≥ximos itens, muda o atributo para mostrar
            proximosItens.forEach(item => {
                item.setAttribute('data-hidden', 'false');
            });

            // Atualiza o contador e verifica se acabaram os itens
            itensVisiveis += proximosItens.length;
            if (document.querySelectorAll('.denuncia-item[data-hidden="true"]').length === 0) {
                btnCarregarMais.classList.add('hidden');
                msgFimLista?.classList.remove('hidden');
            }
        });
    }
</script>