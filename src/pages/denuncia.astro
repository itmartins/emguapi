---
// src/pages/denuncia.astro
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import VozComunidade from '../components/VozComunidade.astro';
import NoticiaCard from '../components/NoticiaCard.astro';

// Busca todas as cole√ß√µes
const noticias = await getCollection('noticias');
const denuncias = await getCollection('denuncias');

// Filtra APENAS as not√≠cias que t√™m a categoria "Voz da Comunidade"
const noticiasVozDaComunidade = noticias.filter(
    item => (item.data as any).categoria === 'Voz da Comunidade'
);

// Unifica as duas listas em um √∫nico array, usando "as any" para o TypeScript n√£o dar erro
const todasAsDenuncias = [
    ...noticiasVozDaComunidade.map(item => ({
        tipo: 'noticia',
        id: item.id,
        slug: item.slug,
        dataPostagem: new Date((item.data as any).data).getTime(),
        dados: item.data as any // CORRE√á√ÉO AQUI: "as any" acalma o TypeScript
    })),
    ...denuncias.map(item => ({
        tipo: 'denuncia_crua',
        id: item.id,
        slug: item.slug,
        dataPostagem: new Date((item.data as any).data).getTime(),
        dados: item.data as any // CORRE√á√ÉO AQUI: "as any" acalma o TypeScript
    }))
].sort((a, b) => b.dataPostagem - a.dataPostagem);

// Lista de bairros consolidada baseada no Ramal Guapimirim
const bairros = [ "√Årea Rural de Guapimirim", "Bananal", "Barreira", "Cadetes Fabres", "Caneca Fina", "Cantagalo", "Centro", "Citrol√¢ndia", "Corujas", "Cotia", "Espinha√ßo", "Garraf√£o", "Iconha", "Jardim Guapimirim", "Limoeiro", "Monte Oliveti", "Nova Mar√≠lia", "Orindi", "Paiol", "Ideal", "Parque Santo Ant√¥nio (Modelo)", "Para√≠so", "Parque Fleixal", "Parque Nossa Senhora da Ajuda", "Parque Santa Eug√™nia", "Parque Silvestre", "Quinta Mariana", "Quinta Ros√¢ngela", "Segredo", "Soberbo", "Vale das Pedrinhas", "Vale do Jequitib√°", "V√°rzea Alegre", "Vila Ol√≠mpia" ];

const problemas = [ "Falta de √Ågua", "Coleta de Lixo", "Ilumina√ß√£o P√∫blica", "Problemas no Trem (Diesel)", "Seguran√ßa", "Buracos/Pavimenta√ß√£o" ];
---

<Layout title="Voz da Comunidade - Den√∫ncias | emguapi.com">
    <Navbar />

    <main class="max-w-4xl mx-auto p-6 my-12">
        
        <section class="bg-white shadow-lg rounded-lg overflow-hidden border-t-8 border-red-base p-8 md:p-12 mb-20 border border-gray-200">
            <header class="mb-10 text-center border-b border-gray-100 pb-8">
                <h1 class="text-4xl font-black text-navy-dark uppercase tracking-tighter">
                    Voz da <span class="text-red-base">Comunidade</span>
                </h1>
                <p class="text-navy-soft mt-2 font-medium">O canal de utilidade p√∫blica de Guapimirim</p>
            </header>

            <form id="denuncia-form" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Localidade</label>
                        <select id="bairro-form" required class="w-full bg-ice text-navy-dark p-4 rounded-sm font-bold border border-gray-200 focus:border-red-base outline-none transition-all cursor-pointer">
                            <option value="">Selecione o Bairro</option>
                            {bairros.map(b => <option value={b}>{b}</option>)}
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Assunto</label>
                        <select id="assunto-form" required class="w-full bg-ice text-navy-dark p-4 rounded-sm font-bold border border-gray-200 focus:border-red-base outline-none transition-all cursor-pointer">
                            <option value="">Tipo de Ocorr√™ncia</option>
                            {problemas.map(p => <option value={p}>{p}</option>)}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Relato do Morador</label>
                    <textarea id="relato-form" rows="5" required placeholder="Descreva o problema com detalhes..." class="w-full bg-ice text-navy-dark p-4 rounded-sm font-medium border border-gray-200 focus:border-red-base outline-none resize-none transition-all"></textarea>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-navy-soft mb-2 tracking-widest">Seu Nome (Opcional)</label>
                    <input type="text" id="nome-form" placeholder="Ex: Dona Maria ou Morador do Centro" class="w-full bg-ice text-navy-dark p-4 rounded-sm font-bold border border-gray-200 focus:border-red-base outline-none transition-all" />
                </div>
                
                <button type="submit" class="w-full bg-navy-dark hover:bg-red-base text-white p-5 rounded-md font-black uppercase tracking-widest shadow-md transition-all active:scale-95 flex items-center justify-center gap-3">
                    Enviar para a Reda√ß√£o no WhatsApp
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-sm border-l-4 border-navy-soft text-center">
                <p class="text-[10px] text-navy-soft uppercase font-bold tracking-wider">As den√∫ncias s√£o recebidas pela nossa equipe e podem ser transformadas em pautas jornal√≠sticas.</p>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-black uppercase tracking-tighter text-navy-dark mb-10 flex items-center gap-3 border-b border-gray-100 pb-4">
                <span class="w-2 h-6 bg-red-base inline-block rounded-sm"></span>
                Relatos e Pautas Recentes
            </h2>

            <div id="denuncias-list" class="grid md:grid-cols-2 gap-6 mb-12">
                {todasAsDenuncias.length > 0 ? (
                    todasAsDenuncias.map((item, index) => (
                        <div class="denuncia-item transition-all duration-500" data-hidden={index >= 4 ? "true" : "false"}>
                            {item.tipo === 'noticia' ? (
                                <NoticiaCard 
                                    categoria={item.dados.categoria}
                                    titulo={item.dados.titulo}
                                    resumo={item.dados.resumo}
                                    data={item.dados.data}
                                    link={`/noticias/${item.slug}`}
                                    imagem={item.dados.imagem || "/fotos/estacao-guapi.jpg"}
                                />
                            ) : (
                                <VozComunidade 
                                    bairro={item.dados.bairro}
                                    relato={item.dados.resumo_relato}
                                    autor={item.dados.autor}
                                />
                            )}
                        </div>
                    ))
                ) : (
                    <div class="col-span-2 bg-white p-12 rounded-lg text-center border border-gray-100 shadow-sm">
                        <p class="text-navy-soft text-sm mb-4">Ainda n√£o h√° relatos publicados.</p>
                    </div>
                )}
            </div>

            {todasAsDenuncias.length > 4 && (
                <div class="text-center pt-6 border-t border-gray-100">
                    <button 
                        id="btn-carregar-mais"
                        class="group flex items-center gap-2 mx-auto text-xs font-black uppercase tracking-widest text-navy-base bg-white border border-navy-base/20 hover:border-navy-base/50 transition-all px-8 py-4 rounded-md shadow-sm"
                    >
                        Carregar mais relatos
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:translate-y-1 transition-transform">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <p id="msg-fim-lista" class="hidden text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mt-6">
                        Todos os relatos foram exibidos.
                    </p>
                </div>
            )}
        </section>

    </main>
</Layout>

<style>
    .denuncia-item[data-hidden="true"] {
        display: none;
        opacity: 0;
        transform: translateY(20px);
    }
    .denuncia-item[data-hidden="false"] {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script>
    const form = document.getElementById('denuncia-form') as HTMLFormElement;
    if (form) {
        form.addEventListener('submit', (e: Event) => {
            e.preventDefault();
            const bairro = (document.getElementById('bairro-form') as HTMLSelectElement).value;
            const assunto = (document.getElementById('assunto-form') as HTMLSelectElement).value;
            const relato = (document.getElementById('relato-form') as HTMLTextAreaElement).value;
            const nome = (document.getElementById('nome-form') as HTMLInputElement).value || "Morador An√¥nimo";
            const mensagem = `üì¢ *DEN√öNCIA - emguapi.com*%0A%0A*Local:* ${bairro}%0A*Assunto:* ${assunto}%0A*Relato:* ${relato}%0A%0A*Enviado por:* ${nome}`;
            window.open(`https://api.whatsapp.com/send?phone=21969400053&text=${mensagem}`, '_blank');
        });
    }

    const btnCarregarMais = document.getElementById('btn-carregar-mais');
    const msgFimLista = document.getElementById('msg-fim-lista');
    let itensVisiveis = 4; 
    const itensPorPagina = 4; 

    if (btnCarregarMais) {
        btnCarregarMais.addEventListener('click', () => {
            const itensEscondidos = document.querySelectorAll('.denuncia-item[data-hidden="true"]');
            const proximosItens = Array.from(itensEscondidos).slice(0, itensPorPagina);

            if (proximosItens.length === 0) {
                btnCarregarMais.classList.add('hidden'); 
                msgFimLista?.classList.remove('hidden'); 
                return;
            }

            proximosItens.forEach(item => {
                item.setAttribute('data-hidden', 'false');
            });

            itensVisiveis += proximosItens.length;
            if (document.querySelectorAll('.denuncia-item[data-hidden="true"]').length === 0) {
                btnCarregarMais.classList.add('hidden');
                msgFimLista?.classList.remove('hidden');
            }
        });
    }
</script>