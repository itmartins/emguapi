---
// src/pages/horarios.astro
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import statusData from '../data/statusTrem.json'; 

// --- DADOS DOS COMUNICADOS FIXOS ---
const comunicadosFixos = [
    {
        data: "12 de fevereiro de 2026 | 14:00",
        titulo: "07 e 08/03 - Interrupção Gramacho-Saracuruna, Guapimirim e Vila Inhomirim",
        texto: "No sábado (07), a partir das 13h, e no domingo (08), durante toda a operação, não haverá circulação de trens no trecho entre as estações Gramacho-Saracuruna e extensões Vila Inhomirim e Guapimirim devido a manutenções na via e rede aérea.",
        tipo: "alerta"
    },
    {
        data: "12 de fevereiro de 2026 | 14:00",
        titulo: "28 e 29/03 - Interrupção Gramacho-Saracuruna, Guapimirim e Vila Inhomirim",
        texto: "No sábado (28), a partir das 13h, e no domingo (29), durante toda a operação, não haverá circulação de trens no trecho entre as estações Gramacho-Saracuruna e extensões Vila Inhomirim e Guapimirim devido a manutenções na via e rede aérea.",
        tipo: "alerta"
    },
];

// --- LÓGICA DE AVISOS DE NOTÍCIAS (Dinâmico) ---
const todasNoticias = (await getCollection('noticias')).sort(
  (a, b) => new Date(b.data.data).getTime() - new Date(a.data.data).getTime()
);

// Filtramos notícias relevantes para operação
const avisosRecentes = todasNoticias.filter(noticia => 
    ['Manutenção', 'Serviço', 'Alerta', 'Segurança'].includes(noticia.data.categoria)
).slice(0, 2);

// --- LÓGICA DE STATUS ---
const statusConfig = {
    'normal': { border: 'border-green-500', text: 'text-green-400', desc: 'Operação Normal', luzCor: 'bg-green-500', luzPing: 'bg-green-400' },
    'atrasado': { border: 'border-yellow-500', text: 'text-yellow-400', desc: 'Com Atrasos', luzCor: 'bg-yellow-500', luzPing: 'bg-yellow-400' },
    'suspenso': { border: 'border-red-500', text: 'text-red-400', desc: 'Operação Suspensa', luzCor: 'bg-red-500', luzPing: 'bg-red-400' },
    'manutencao': { border: 'border-blue-500', text: 'text-blue-400', desc: 'Manutenção', luzCor: 'bg-blue-500', luzPing: 'bg-blue-400' }
};

const currentStatusState = statusData.estado.toLowerCase() as keyof typeof statusConfig;
const currentConfig = statusConfig[currentStatusState] || statusConfig['normal'];

// --- DADOS DAS ESTAÇÕES ---
const estacoesData = [
    { nome: "Guapimirim" }, { nome: "Parada Bananal" }, { nome: "Parada Modelo" }, 
    { nome: "Jardim Guapimirim" }, { nome: "Parada Ideal" }, { nome: "Citrolândia" }, 
    { nome: "Jororó" }, { nome: "Jardim Nova Marília" }, { nome: "Magé" }, 
    { nome: "Iriri" }, { nome: "Santa Guilhermina" }, { nome: "Suruí" }, 
    { nome: "Santa Dalila" }, { nome: "Parque Estrela" }, { nome: "Saracuruna" }
];
---

<Layout title="Planejar Viagem | emguapi.com">
    <Navbar />

    <main class="max-w-5xl mx-auto p-6 my-8">
        <section class="bg-navy-dark text-white p-8 md:p-10 rounded-lg shadow-xl mb-12 border-b-8 border-red-base">
            
            <header class="mb-10 text-center md:text-left">
                <h2 class="text-3xl font-black uppercase tracking-tighter">Planeje sua Viagem</h2>
                <p class="text-red-light text-xs font-bold uppercase tracking-widest mt-1">Horários baseados na grade oficial</p>
            </header>
            
            <form id="planning-form" class="space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest">Partida de:</label>
                        <select id="origin" class="w-full bg-navy-base text-white p-4 rounded-sm font-bold border border-transparent focus:border-red-base outline-none transition-all cursor-pointer">
                            {estacoesData.map(e => <option value={e.nome}>{e.nome}</option>)}
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest">Destino:</label>
                        <select id="destination" class="w-full bg-navy-base text-white p-4 rounded-sm font-bold border border-transparent focus:border-red-base outline-none cursor-pointer">
                            {[...estacoesData].reverse().map(e => <option value={e.nome}>{e.nome}</option>)}
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-8">
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest">Tipo de Dia:</label>
                        <select id="day-type" class="w-full bg-navy-base text-white p-4 rounded-sm font-bold border border-transparent focus:border-red-base outline-none cursor-pointer">
                            <option value="util">Segunda a Sexta</option>
                            <option value="sabado">Sábados</option>
                            <option value="domingo">Domingos e Feriados</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest">A partir das:</label>
                        <input type="time" id="travel-time" class="w-full bg-navy-base text-white p-4 rounded-sm font-bold border border-transparent focus:border-red-base outline-none" />
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-red-base hover:bg-red-light p-4 rounded-md font-black uppercase transition-all shadow-md active:scale-95 text-white tracking-widest">
                            Pesquisar Viagem
                        </button>
                    </div>
                </div>
            </form>

            <div id="result-box" class="hidden mt-12 p-8 bg-navy-base/50 rounded-lg border border-white/10 backdrop-blur-sm">
                <div id="has-train" class="hidden">
                    <div class="flex flex-col md:flex-row justify-around items-center gap-10 mb-8">
                        <div class="text-center">
                            <span class="text-[10px] uppercase font-black opacity-40 block mb-3 tracking-widest">Partida de <span id="lbl-origin" class="text-white"></span></span>
                            <p id="dep-time" class="text-5xl md:text-6xl font-black">--:--</p>
                        </div>
                        <div class="hidden md:block h-20 w-px bg-white/10"></div>
                        <div class="text-center">
                            <span class="text-[10px] uppercase font-black text-red-light block mb-3 tracking-widest">Chegada em <span id="lbl-dest" class="text-red-light"></span></span>
                            <p id="arr-time" class="text-5xl md:text-6xl font-black text-red-light">--:--</p>
                            <p id="next-day-alert" class="hidden text-[10px] font-bold text-yellow-400 mt-2 uppercase tracking-widest">Viagem no dia seguinte</p>
                        </div>
                    </div>

                    {/* Caixa Dinâmica de Integração (Saracuruna <> Central) */}
                    <div id="connection-box" class="hidden bg-white/5 rounded-md p-4 border border-white/10 flex items-start gap-4">
                        <div class="bg-blue-600 text-white p-2 rounded-sm shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-black uppercase text-sm text-blue-400 mb-1 tracking-widest">Integração Trem Elétrico (Central do Brasil)</h4>
                            <p id="connection-text" class="text-sm text-gray-300 leading-relaxed"></p>
                        </div>
                    </div>
                </div>

                <div id="no-train" class="hidden text-center py-6">
                    <p class="text-lg font-bold text-red-light uppercase">Nenhuma viagem encontrada.</p>
                </div>
            </div>
        </section>

        <section class="grid lg:grid-cols-3 gap-8 mb-16">
            <div class="lg:col-span-2 space-y-6">
                <h3 class="text-xl font-black uppercase tracking-tighter text-navy-dark flex items-center gap-2 border-b border-gray-100 pb-3">
                    <span class="w-2 h-6 bg-red-base rounded-sm"></span>
                    Comunicados Oficiais
                </h3>

                <div class="grid md:grid-cols-2 gap-4">
                    {comunicadosFixos.map(aviso => {
                        let borderClass = 'border-navy-base';
                        if (aviso.tipo === 'alerta') borderClass = 'border-yellow-500';
                        if (aviso.tipo === 'crime') borderClass = 'border-red-base';
                        if (aviso.tipo === 'manutencao') borderClass = 'border-blue-500';

                        return (
                            <div class={`bg-white p-6 rounded-lg border-l-4 border border-gray-100 ${borderClass} shadow-sm hover:shadow-md transition-shadow`}>
                                <span class="text-[10px] font-black text-navy-soft uppercase tracking-widest mb-2 block">{aviso.data}</span>
                                <h4 class="text-navy-dark font-black uppercase text-sm mb-3 leading-tight">{aviso.titulo}</h4>
                                <p class="text-xs text-gray-600 leading-relaxed">{aviso.texto}</p>
                            </div>
                        )
                    })}
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-navy-dark text-white p-8 rounded-lg shadow-md relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z" />
                        </svg>
                    </div>

                    <h3 class="text-xl font-black uppercase tracking-tighter mb-6 relative z-10 border-b border-white/20 pb-3">Tarifas</h3>
                    
                    <div class="space-y-4 relative z-10">
                        <div>
                            <span class="text-[10px] uppercase font-black tracking-widest text-white/50 block mb-1">Passagem Unitária</span>
                            <div class="flex items-baseline justify-between border-b border-white/10 pb-2">
                                <span class="text-sm font-bold">Tarifa Cheia</span>
                                <span class="text-2xl font-black text-red-light">R$ 7,40</span>
                            </div>
                        </div>
                         <div>
                            <span class="text-[10px] uppercase font-black tracking-widest text-white/50 block mb-1">Bilhete Único (BUI)</span>
                            <div class="flex items-baseline justify-between border-b border-white/10 pb-2">
                                <span class="text-sm font-bold">Tarifa Social</span>
                                <span class="text-2xl font-black text-green-400">R$ 5,00</span>
                            </div>
                        </div>
                        <div>
                            <span class="text-[10px] uppercase font-black tracking-widest text-white/50 block mb-1">Integração</span>
                            <div class="flex items-baseline justify-between">
                                <span class="text-sm font-bold">Trem + Metrô/Ônibus</span>
                                <span class="text-xl font-black">R$ 9,40</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-100 rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-black uppercase tracking-tighter text-navy-dark mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-navy-base">
                                    <circle cx="5.5" cy="17.5" r="3.5" />
                                    <circle cx="18.5" cy="17.5" r="3.5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 6h2.5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 17.5V14l-3-3 4-3 2 3h2" />
                        </svg>
                        Bike no Trem
                    </h3>
                    
                    <div class="bg-white rounded-sm p-4 mb-4 border border-gray-200">
                        <p class="text-[10px] font-black text-navy-dark uppercase tracking-widest mb-2 border-b border-gray-100 pb-2">Horários Permitidos:</p>
                        <ul class="text-xs text-gray-600 space-y-2 font-medium">
                            <li>• <strong>Dias úteis:</strong> A partir das 21h</li>
                            <li>• <strong>Sábados, domingos e feriados:</strong> O dia todo</li>
                        </ul>
                    </div>

                    <details class="group bg-white rounded-sm border border-gray-200 overflow-hidden cursor-pointer shadow-sm">
                        <summary class="flex items-center justify-between p-4 font-black text-xs uppercase tracking-widest text-navy-dark hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                Regras de Embarque com Bicicletas
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-red-base transition-transform group-open:rotate-180">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </summary>
                        <div class="p-4 pt-0 text-xs text-gray-600 space-y-2 leading-relaxed bg-gray-50 border-t border-gray-100 font-medium">
                            <p>• Procure um funcionário para liberar o acesso pelo portão de serviço.</p>
                            <p>• Proibido: Bicicleta de carga, motorizada ou elétrica.</p>
                            <p>• Dentro da estação: Empurre a bicicleta, não pedale.</p>
                            <p>• Use as escadas fixas. Proibido usar escada rolante ou elevador.</p>
                            <p>• Na plataforma: Respeite a faixa amarela.</p>
                            <p>• No trem: Não bloqueie as portas.</p>
                            <p class="text-[10px] italic mt-4 opacity-70 border-t border-gray-200 pt-2">Grupos acima de 10 pessoas: Agendar com antecedência via 0800 726 9494.</p>
                        </div>
                    </details>
                </div>

            </div>
        </section>
    </main>

    <script define:vars={{ estacoesData }}>
        // --- DADOS REAIS DE TEMPO DE VIAGEM (OFFSETS EM MINUTOS) ---
        const timeOffsets = {
            "Guapimirim": 0, "Parada Bananal": 6, "Parada Modelo": 10, "Jardim Guapimirim": 14,
            "Parada Ideal": 19, "Citrolândia": 25, "Jororó": 29, "Jardim Nova Marília": 34,
            "Magé": 42, "Iriri": 50, "Santa Guilhermina": 57, "Suruí": 65,
            "Santa Dalila": 72, "Parque Estrela": 80, "Saracuruna": 90
        };

        const baseSchedules = {
            util: {
                fromGuapi:      ["03:55", "05:45", "10:30", "12:00", "15:20", "16:40", "19:35"], 
                fromSaracuruna: ["05:40", "07:30", "09:20", "12:15", "14:00", "18:00", "20:10"]  
            },
            sabado: {
                fromGuapi:      ["04:16", "06:55", "11:20", "14:20", "18:20"], 
                fromSaracuruna: ["06:30", "08:50", "12:35", "16:30", "20:00"]
            },
            domingo: {
                fromGuapi:      ["05:00", "11:50", "14:50", "17:28"],
                fromSaracuruna: ["08:24", "13:24", "16:04", "19:04"]
            }
        };

        // Função robusta para somar ou subtrair minutos
        function addMinutes(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m + minutes);
            return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        }

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        // Configura a hora atual ao carregar a página
        const now = new Date();
        const currentTimeString = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        const timeInput = document.getElementById('travel-time');
        if (timeInput) timeInput.value = currentTimeString;

        const form = document.getElementById('planning-form');
        
        form?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const dayType = document.getElementById('day-type').value;
            const selectedTime = document.getElementById('travel-time').value;
            const selectedTotalMinutes = timeToMinutes(selectedTime);

            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            
            const idxOrigin = estacoesData.findIndex(e => e.nome === origin);
            const idxDest = estacoesData.findIndex(e => e.nome === destination);

            if (idxOrigin === idxDest) {
                alert("Por favor, selecione origem e destino diferentes.");
                return;
            }

            const direction = (idxOrigin < idxDest) ? "goingToSaracuruna" : "goingToGuapi";
            
            const currentGrade = baseSchedules[dayType];
            const baseTrips = (direction === "goingToSaracuruna") 
                ? currentGrade.fromGuapi 
                : currentGrade.fromSaracuruna;

            let foundTrip = null;
            let isNextDay = false;

            // Busca a primeira viagem disponível
            for (let tripBaseTime of baseTrips) {
                let departureAtOrigin;
                let arrivalAtDest;

                if (direction === "goingToSaracuruna") {
                    departureAtOrigin = addMinutes(tripBaseTime, timeOffsets[origin]);
                    arrivalAtDest = addMinutes(tripBaseTime, timeOffsets[destination]);
                } else {
                    const totalTripTime = 90;
                    const invOffsetOrigin = totalTripTime - timeOffsets[origin];
                    const invOffsetDest = totalTripTime - timeOffsets[destination];
                    departureAtOrigin = addMinutes(tripBaseTime, invOffsetOrigin);
                    arrivalAtDest = addMinutes(tripBaseTime, invOffsetDest);
                }

                if (timeToMinutes(departureAtOrigin) >= selectedTotalMinutes) {
                    foundTrip = { dep: departureAtOrigin, arr: arrivalAtDest };
                    break;
                }
            }

            // CORREÇÃO: Se não achar viagem hoje, pega a primeira do dia seguinte
            if (!foundTrip && baseTrips.length > 0) {
                let tripBaseTime = baseTrips[0];
                let departureAtOrigin;
                let arrivalAtDest;

                if (direction === "goingToSaracuruna") {
                    departureAtOrigin = addMinutes(tripBaseTime, timeOffsets[origin]);
                    arrivalAtDest = addMinutes(tripBaseTime, timeOffsets[destination]);
                } else {
                    const totalTripTime = 90;
                    const invOffsetOrigin = totalTripTime - timeOffsets[origin];
                    const invOffsetDest = totalTripTime - timeOffsets[destination];
                    departureAtOrigin = addMinutes(tripBaseTime, invOffsetOrigin);
                    arrivalAtDest = addMinutes(tripBaseTime, invOffsetDest);
                }
                foundTrip = { dep: departureAtOrigin, arr: arrivalAtDest };
                isNextDay = true;
            }

            const resultBox = document.getElementById('result-box');
            const hasTrainDiv = document.getElementById('has-train');
            const noTrainDiv = document.getElementById('no-train');
            const connectionBox = document.getElementById('connection-box');
            const nextDayAlert = document.getElementById('next-day-alert');
            
            resultBox.classList.remove('hidden');

            if (foundTrip) {
                hasTrainDiv.classList.remove('hidden');
                noTrainDiv.classList.add('hidden');
                
                document.getElementById('lbl-origin').innerText = origin;
                document.getElementById('lbl-dest').innerText = destination;
                document.getElementById('dep-time').innerText = foundTrip.dep;
                document.getElementById('arr-time').innerText = foundTrip.arr;

                if(isNextDay) {
                    nextDayAlert.classList.remove('hidden');
                } else {
                    nextDayAlert.classList.add('hidden');
                }

                connectionBox.classList.add('hidden');

                // CORREÇÃO: Lógica para calcular viagem e integração até a Central do Brasil
                if (destination === "Saracuruna") {
                    connectionBox.classList.remove('hidden');
                    const waitTime = (dayType === 'util') ? 15 : 25; // 15 min na semana, 25 fds
                    const nextTrain = addMinutes(foundTrip.arr, waitTime);
                    const arrivalCentral = addMinutes(nextTrain, 55); // Tempo médio Saracuruna-Central

                    document.getElementById('connection-text').innerHTML = 
                        `Chegada em Saracuruna às <strong>${foundTrip.arr}</strong>.<br>
                         Previsão de embarque para a Central: <strong>${nextTrain}</strong>.<br>
                         Chegada estimada na Central do Brasil: <strong>${arrivalCentral}</strong>.`;
                }

                if (origin === "Saracuruna") {
                    connectionBox.classList.remove('hidden');
                    // Se o trem parte de Saracuruna em 'foundTrip.dep', a pessoa tem que ter pego na Central 70 min antes (55 de viagem + 15 de espera).
                    const departureCentral = addMinutes(foundTrip.dep, -70); 

                    document.getElementById('connection-text').innerHTML = 
                        `Partida para Guapimirim às <strong>${foundTrip.dep}</strong>.<br>
                         Para pegar esta conexão, embarque na Central do Brasil por volta de <strong>${departureCentral}</strong>.`;
                }

            } else {
                hasTrainDiv.classList.add('hidden');
                noTrainDiv.classList.remove('hidden');
            }
        });
    </script>
</Layout>