---
// src/pages/noticias/[slug].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import NoticiaCard from '../../components/NoticiaCard.astro'; 

export async function getStaticPaths() {
  const noticiaEntries = await getCollection('noticias');
  return noticiaEntries.map(entry => ({
    params: { slug: entry.id.replace(/\.md$/, '') }, 
    props: { entry },
  }));
}

// Função para limpar o texto da URL das tags
const formatarTagParaURL = (tag: string) => {
  return tag.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-');
};

const { entry } = Astro.props;
const { Content } = await entry.render();

// --- LÓGICA DE NOTÍCIAS RELACIONADAS ---
const allNoticias = await getCollection('noticias');
const noticiasRelacionadas = allNoticias
    .filter(n => n.id !== entry.id) 
    .sort((a, b) => new Date(b.data.data).getTime() - new Date(a.data.data).getTime())
    .slice(0, 3);

// Tratamento seguro do Autor
const nomeAutor = entry.data.autor || "Redação emguapi";
const autorSlug = nomeAutor.toLowerCase().trim().replace(/\s+/g, '-');

const dataFormatada = new Date(entry.data.data).toLocaleDateString('pt-BR', {
  day: '2-digit',
  month: 'long',
  year: 'numeric'
});

const shareUrl = `https://emguapi.com/noticias/${entry.id.replace(/\.md$/, '')}`;
const shareText = encodeURIComponent(entry.data.titulo);
---

<Layout 
    title={`${entry.data.titulo} | emguapi.com`}
    description={entry.data.resumo}
    image={entry.data.imagem}
    tags={entry.data.tags}
>
    <Navbar />
    
    {/* CONTAINER PRINCIPAL: Mudado para rounded-lg e border-gray-200 */}
    <main class="max-w-4xl mx-auto my-12 bg-white shadow-xl rounded-lg overflow-hidden border border-gray-200">
        
        {/* HEADER DA NOTÍCIA */}
        <header class="relative h-[400px] md:h-[500px]">
            <img 
                src={entry.data.imagem || "/fotos/estacao-guapi.jpg"} 
                class="w-full h-full object-cover" 
                alt={entry.data.titulo} 
            />
            <div class="absolute inset-0 bg-gradient-to-t from-[#000033]/95 via-[#000033]/20 to-transparent"></div>
            <div class="absolute bottom-10 left-8 right-8 md:left-12 md:right-12">
                {/* TAG: Mudada para Navy e rounded-sm */}
                <span class="bg-navy-base text-white text-[10px] font-black px-3 py-1.5 rounded-sm uppercase mb-4 inline-block tracking-widest shadow-md">
                    {entry.data.categoria}
                </span>
                {/* TÍTULO: Sem itálico e com peso visual */}
                <h1 class="text-3xl md:text-5xl font-black text-white tracking-tighter leading-tight drop-shadow-lg">
                    {entry.data.titulo}
                </h1>
            </div>
        </header>

        <article class="p-8 md:p-16">
            {/* META INFO E SHARE */}
            <div class="flex flex-wrap items-center justify-between gap-6 mb-10 pb-6 border-b border-gray-100">
                <div class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">
                    {dataFormatada} <span class="mx-2 text-gray-300">|</span> Por 
                    <a href={`/autor/${autorSlug}`} class="text-red-base hover:text-navy-base transition-colors">
                        {nomeAutor}
                    </a>
                </div>

                <div class="flex gap-2">
                    {/* BOTÕES DE SHARE: Mudados para rounded-md e texto menor */}
                    <a href={`https://wa.me/?text=${shareText}%20${shareUrl}`} target="_blank" class="bg-[#25D366] text-white px-4 py-2 rounded-md hover:opacity-90 transition-all text-[9px] font-black uppercase shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/></svg>
                        WhatsApp
                    </a>
                    <a href={`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`} target="_blank" class="bg-[#1877F2] text-white px-4 py-2 rounded-md hover:opacity-90 transition-all text-[9px] font-black uppercase shadow-sm">
                        Facebook
                    </a>
                </div>
            </div>

            {/* CONTEÚDO DA MATÉRIA */}
            <div class="
                prose prose-lg max-w-none text-gray-700 leading-relaxed
                prose-headings:font-black prose-headings:text-navy-dark prose-headings:uppercase prose-headings:tracking-tight
                prose-a:text-red-base hover:prose-a:text-navy-base
                prose-strong:text-navy-dark prose-strong:font-black
                prose-img:rounded-lg prose-img:shadow-md prose-img:w-full
                
                [&_iframe]:w-full [&_iframe]:aspect-video [&_iframe]:rounded-lg [&_iframe]:shadow-md [&_iframe]:mb-8
                
                [&_figure]:my-8             
                [&_figure]:block
                [&_figcaption]:text-center  
                [&_figcaption]:text-xs      
                [&_figcaption]:text-gray-500 
                [&_figcaption]:mt-3         
                [&_figcaption]:font-bold
                [&_figcaption]:tracking-widest
                [&_figcaption]:uppercase

                [&>p:first-of-type::first-letter]:float-left
                [&>p:first-of-type::first-letter]:text-[4rem]
                [&>p:first-of-type::first-letter]:leading-[0.8]
                [&>p:first-of-type::first-letter]:font-black
                [&>p:first-of-type::first-letter]:mr-3
                [&>p:first-of-type::first-letter]:mt-2
                [&>p:first-of-type::first-letter]:text-red-base
                [&>p:first-of-type::first-letter]:uppercase

                prose-blockquote:not-italic
                prose-blockquote:font-bold
                prose-blockquote:text-navy-base
                prose-blockquote:bg-gray-50
                prose-blockquote:border-l-8
                prose-blockquote:border-red-base
                prose-blockquote:py-6
                prose-blockquote:px-8
                prose-blockquote:rounded-r-md
                prose-blockquote:shadow-sm
                prose-blockquote:border-y prose-blockquote:border-r prose-blockquote:border-gray-100
            ">
                <Content />
            </div>

            {/* TAGS */}
            {entry.data.tags && entry.data.tags.length > 0 && (
                <div class="mt-12 mb-12 pt-8 border-t border-gray-100">
                    <h4 class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-4">Tópicos Relacionados:</h4>
                    <div class="flex flex-wrap gap-2">
                        {entry.data.tags.map((tag: string) => (
                            <a 
                                href={`/tags/${formatarTagParaURL(tag)}`}
                                class="bg-gray-50 hover:bg-red-base hover:text-white text-gray-500 text-[9px] font-black uppercase px-3 py-1.5 rounded-sm border border-gray-200 transition-colors"
                            >
                                #{tag}
                            </a>
                        ))}
                    </div>
                </div>
            )}
            
            {/* RELACIONADAS */}
            <div class="mt-20 pt-12 border-t-2 border-gray-100">
                <h3 class="text-xl font-black uppercase tracking-tighter text-navy-dark mb-8 flex items-center gap-3">
                    <span class="w-2 h-6 bg-red-base inline-block rounded-sm"></span>
                    Você pode gostar
                </h3>
                
                <div class="grid md:grid-cols-3 gap-6">
                    {noticiasRelacionadas.map(noticia => (
                        <div class="h-full"> 
                            <NoticiaCard 
                                categoria={noticia.data.categoria}
                                titulo={noticia.data.titulo}
                                resumo=""
                                data={noticia.data.data}
                                link={`/noticias/${noticia.id.replace(/\.md$/, '')}`}
                                imagem={noticia.data.imagem || "/fotos/estacao-guapi.jpg"}
                            />
                        </div>
                    ))}
                </div>
            </div>

            {/* PUBLICIDADE HORIZONTAL */}
            <div class="mt-16 pt-12 border-t border-gray-100 flex flex-col items-center">
                <span class="text-[9px] font-black text-gray-400 uppercase tracking-[0.3em] mb-4">Espaço Publicitário</span>
                <div class="w-full h-48 md:h-32 bg-gray-50 rounded-lg flex items-center justify-center group cursor-pointer border border-gray-200 hover:border-red-base/50 transition-all overflow-hidden relative shadow-sm">
                    <img src="/banners/seu-anuncio.webp" 
                        class="w-full h-full object-contain opacity-90 group-hover:opacity-100 transition-opacity" 
                        alt="Publicidade">
                    <a href="https://www.gigamaisfibra.com.br/" target="_blank" rel="noopener noreferrer sponsored" class="absolute inset-0 z-10">
                        <span class="sr-only">Visitar site do anunciante</span>
                    </a>
                </div>
            </div>

            <footer class="mt-16 pt-8 border-t border-gray-100 flex justify-between items-center">
                <a href="/noticias" class="text-navy-base font-black uppercase text-[16px] tracking-widest hover:text-red-base transition-colors flex items-center gap-2 group">
                    <span class="group-hover:-translate-x-1 transition-transform">←</span> Voltar para Notícias
                </a>
                <p class="text-gray-400 text-[9px] font-bold uppercase tracking-widest italic"></p>
            </footer>
        </article>
    </main>
</Layout>